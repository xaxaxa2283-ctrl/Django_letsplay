{% extends 'main/base_template.html' %}
{% load static %}

{% block content %}
<section class="page-section">
  <div class="container">


    <div class="page-header">
      <h1>Отзывы наших клиентов</h1>
      <p>Более 1900 довольных клиентов делятся своим опытом покупок в LetsPlay</p>
    </div>

        <!-- Statistics Banner -->
        <div class="stats-banner">
            <div class="stats-banner-grid">
                <div class="stats-banner-item">
                    <div class="stats-banner-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                        </svg>
                    </div>
                    <div class="stats-banner-value">{{ stats.total_clients }}</div>
                    <p>Довольных клиентов</p>
                </div>

                <div class="stats-banner-item">
                    <div class="stats-banner-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                    </div>
                    <div class="stats-banner-value">{{ stats.rating }}</div>
                    <p>Средняя оценка</p>
                </div>

                <div class="stats-banner-item">
                    <div class="stats-banner-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                    </div>
                    <div class="stats-banner-value">{{ stats.recommendations }}%</div>
                    <p>Рекомендуют друзьям</p>
                </div>
            </div>
        </div>

        <!-- Reviews Grid -->
        <div class="reviews-grid" id="reviewsGrid">
      {% for review in reviews %}
      <div class="review-card">
        <div class="quote-icon">
          <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
          </svg>
        </div>

        <div class="review-header">
          <div class="review-avatar">{{ review.avatar }}</div>
          <div>
            <h3>{{ review.name }}</h3>
            <p class="review-date">{{ review.date }}</p>
            <div class="review-rating">
              {% for i in "12345" %}
              <svg class="star {% if forloop.counter <= review.rating %}filled{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
              {% endfor %}
            </div>
          </div>
        </div>

        <p class="review-text">{{ review.text }}</p>

        <div class="review-footer">
          <button class="review-action like-btn" data-id="{{ review.id }}">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
            </svg>
            <span>{{ review.likes }}</span>
          </button>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="text-center">
      <button id="loadMoreReviewsBtn" class="btn btn-secondary">Показать ещё отзывы</button>
    </div>

        <!-- CTA Section -->
        <div class="cta-card">
            <div class="cta-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
            </div>
            <h2>Поделитесь своим опытом</h2>
            <p>Ваше мнение очень важно для нас и помогает другим клиентам сделать правильный выбор</p>
            <a href="{% url 'letsplay:submit_review' %}" class="btn btn-primary btn-large">Оставить отзыв</a>


        </div>
    </div>


<!-- Модальное окно
<div id="reviewModal" class="modal hidden">
  <div class="modal-content">
    <h2>Оставить отзыв</h2>
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn btn-primary">Отправить</button>
    </form>
    <button class="modal-close">Закрыть</button>
  </div>
</div>-->

<script>
  const modal = document.getElementById('reviewModal');
  const openBtn = document.querySelector('.btn.btn-primary.btn-large');
  const closeBtn = document.querySelector('.modal-close');

  openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
  closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
</script>



</section>
    <script>
document.addEventListener('DOMContentLoaded', function() {
  let offset = document.querySelectorAll('.review-card').length;
  const grid = document.getElementById('reviewsGrid');
  const loadUrl = "{% url 'letsplay:load_more_reviews' %}";
  const loadMoreBtn = document.getElementById('loadMoreReviewsBtn');


  loadMoreBtn.addEventListener('click', function() {
    loadMoreBtn.disabled = true;
    loadMoreBtn.textContent = 'Загрузка...';

    fetch(`${loadUrl}?offset=${offset}`)
      .then(res => res.json())
      .then(data => {
        if (!data.reviews || data.reviews.length === 0) {
          loadMoreBtn.style.display = 'none';
          return;
        }

        data.reviews.forEach(r => {
          const html = `
            <div class="review-card">
              <div class="quote-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/></svg></div>
              <div class="review-header">
                <div class="review-avatar">${r.avatar}</div>
                <div>
                  <h3>${r.name}</h3>
                  <p class="review-date">${r.date}</p>
                  <div class="review-rating">
                    ${[1,2,3,4,5].map(i => `<svg class="star ${i <= r.rating ? 'filled' : ''}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>`).join('')}
                  </div>
                </div>
              </div>
              <p class="review-text">${r.text}</p>
              <div class="review-footer">
                <button class="review-action like-btn" data-id="${r.id}">
                  <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                  </svg>
                  <span>${r.likes}</span>
                </button>
              </div>
            </div>`;
          grid.insertAdjacentHTML('beforeend', html);
        });

        offset += data.reviews.length;
        if (data.reviews.length < 6) loadMoreBtn.style.display = 'none';
      })
      .catch(err => console.error(err))
      .finally(() => {
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'Показать ещё отзывы';
      });
  });
});
    </script>

    <style>
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
}
.modal.hidden { display: none; }
.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 1rem;
  max-width: 400px;
  width: 100%;
}
.like-btn.liked .icon {
    stroke: #00BCD4;
}


</style>
{% if messages %}
  <div class="toast-container" id="toast-container">
    {% for message in messages %}
      <div class="toast {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  let offset = document.querySelectorAll('.review-card').length;
  const grid = document.getElementById('reviewsGrid');
  const loadUrl = "{% url 'letsplay:load_more_reviews' %}";
  const loadMoreBtn = document.getElementById('loadMoreReviewsBtn');

  loadMoreBtn.addEventListener('click', function() {
    loadMoreBtn.disabled = true;
    loadMoreBtn.textContent = 'Загрузка...';

    fetch(`${loadUrl}?offset=${offset}`)
      .then(res => res.json())
      .then(data => {
        if (!data.reviews || data.reviews.length === 0) {
          loadMoreBtn.style.display = 'none';
          return;
        }

        data.reviews.forEach(r => {
          const html = `
            <div class="review-card">
              <div class="quote-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14.017..." /></svg></div>
              <div class="review-header">
                <div class="review-avatar">${r.avatar}</div>
                <div>
                  <h3>${r.name}</h3>
                  <p class="review-date">${r.date}</p>
                  <div class="review-rating">
                    ${[1,2,3,4,5].map(i => `<svg class="star ${i <= r.rating ? 'filled' : ''}" fill="currentColor" ...></svg>`).join('')}
                  </div>
                </div>
              </div>
              <p class="review-text">${r.text}</p>
              <div class="review-footer">
                <button class="review-action like-btn" data-id="${r.id}">
                  <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path ... />
                  </svg>
                  <span>${r.likes}</span>
                </button>
              </div>
            </div>`;
          grid.insertAdjacentHTML('beforeend', html);
        });

        offset += data.reviews.length;
        if (data.reviews.length < 6) loadMoreBtn.style.display = 'none';
      })
      .finally(() => {
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'Показать ещё отзывы';
      });
  });
});


document.addEventListener("click", function(e) {
    const btn = e.target.closest(".like-btn");
    if (!btn) return;

    const id = btn.dataset.id;

    fetch(`/review/${id}/like/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            btn.querySelector("span").textContent = data.likes;

            if (data.liked) {
                btn.classList.add("liked");
            } else {
                btn.classList.remove("liked");
            }
        }
    });
});

function getCookie(name) {
    let cookieValue = null;
    document.cookie.split(';').forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        }
    });
    return cookieValue;
}
</script>




{% endblock %}
