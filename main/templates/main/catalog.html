{% extends 'main/base_template.html' %}
{% load static %}

{% block content %}
<section class="page-section">
    <div class="container">
        <div class="page-header">
            <h1>Каталог товаров</h1>
            <p>Широкий выбор игровых консолей, аксессуаров и подписок PlayStation</p>
        </div>

        <!-- Category Filters -->
 <div class="category-filters" id="categoryFilters">
    <a href="{% url 'letsplay:catalog' %}?category=all"
       class="filter-btn {% if current_category == 'all' %}active{% endif %}">
       Все товары
    </a>

    {% for category in categories %}
        <a href="{% url 'letsplay:catalog' %}?category={{ category.category_type }}"
           class="filter-btn {% if current_category == category.category_type %}active{% endif %}">
           {{ category.get_category_type_display }}
        </a>
    {% endfor %}
</div>

        <!-- Products Grid -->
        <div class="products-grid" id="productsGrid">
            {% for product in products %}
            <div class="product-card" data-category="{{ product.category }}">
                {% if product.image %}
                <div class="product-image">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy">
                    {% if product.badge %}
                    <span class="product-badge">{{ product.badge }}</span>
                    {% endif %}
                </div>
                {% endif %}

                <div class="product-content">
                    <div class="product-rating">
                        {% for i in "12345" %}
                        <svg class="star {% if forloop.counter <= product.rating %}filled{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        {% endfor %}
                    </div>

                    <h3 class="product-name">{{ product.name }}</h3>

                    <ul class="product-features">
                        {% for feature in product.features %}
                        <li>{{ feature }}</li>
                        {% endfor %}
                    </ul>

                    <div class="product-price">
                        <span class="price-current">{{ product.price|floatformat:0 }} ₽</span>
                        {% if product.old_price %}
                        <span class="price-old">{{ product.old_price|floatformat:0 }} ₽</span>
                        {% endif %}
                    </div>
                <form action="{% url 'letsplay:add_to_cart' product.id %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">Купить</button>
    </form>
                <a href="{% url 'letsplay:catalog_detail_by_slug' product.slug %}" class="btn btn-primary ">Подробнее

</a>



                </div>
            </div>
            {% endfor %}
        </div>

        <div class="text-center">
            {% if show_button %}
            <button id="load-more-btn" class="btn btn-secondary">Показать ещё</button>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- элементы ---
    const filterBtns = document.querySelectorAll('.filter-btn');
    const productsContainer = document.getElementById('productsGrid');
    const loadMoreBtn = document.getElementById('load-more-btn');

    // --- фильтр ---
    let currentCategory = 'all';
    function applyFilterToAll() {
        const cards = productsContainer.querySelectorAll('.product-card');
        cards.forEach(card => {
            if (currentCategory === 'all' || card.dataset.category === currentCategory) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            currentCategory = this.dataset.category;
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            applyFilterToAll();
        });
    });

    // --- загрузка по клику "Показать ещё" ---
    let offset = document.querySelectorAll('.product-card').length;
    const loadUrl = "{% url 'letsplay:load_more_products' %}";

    function buildCardHtml(p) {
        // Возвращает HTMLElement для продукта p (p — объект из JSON)
        const wrapper = document.createElement('div');
        wrapper.className = 'product-card';
        wrapper.dataset.category = p.category || 'all';

        const imgHtml = p.image ? `
            <div class="product-image">
                <img src="${p.image}" alt="${p.name}" loading="lazy">
                ${p.badge ? `<span class="product-badge">${p.badge}</span>` : ''}
            </div>
        ` : '';

        // Рейтинг: строим 5 звёзд, добавляем класс filled для рейтинга
        let stars = '';
        const rating = p.rating || 0;
        for (let i=1; i<=5; i++) {
            stars += `<svg class="star ${i <= rating ? 'filled' : ''}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>`;
        }

        const featuresHtml = (p.features || []).map(f => `<li>${f}</li>`).join('');

        wrapper.innerHTML = `
            ${imgHtml}
            <div class="product-content">
                <div class="product-rating">${stars}</div>
                <h3 class="product-name">${p.name}</h3>
                <ul class="product-features">${featuresHtml}</ul>
                <div class="product-price">
                    <span class="price-current">${Number(p.price).toLocaleString('ru-RU')} ₽</span>
                    ${p.old_price ? `<span class="price-old">${Number(p.old_price).toLocaleString('ru-RU')} ₽</span>` : ''}
                </div>
                <button class="btn btn-primary btn-full">Подробнее</button>
            </div>
        `;
        return wrapper;
    }

    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Загрузка...';

            fetch(`${loadUrl}?offset=${offset}`)
                .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.json();
                })
                .then(data => {
                    const products = data.products || [];
                    if (products.length === 0) {
                        // больше нет товаров
                        loadMoreBtn.style.display = 'none';
                        return;
                    }
                    products.forEach(p => {
                        const card = buildCardHtml(p);
                        productsContainer.appendChild(card);
                    });
                    // обновляем offset
                    offset += products.length;
                    // применяем фильтр к новым карточкам
                    applyFilterToAll();
                    // если пришло меньше лимита — скрываем кнопку
                    if (products.length < 6) {
                        loadMoreBtn.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Ошибка при загрузке:', err);
                })
                .finally(() => {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Показать ещё';
                });
        });
    }
});
</script>
{% endblock %}
